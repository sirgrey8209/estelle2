# Phase 3: 통합 테스트 및 안정화

> **목표**: 전체 시스템이 안정적으로 동작함
> **상태**: 진행 중
> **선행**: Phase 1, 2 완료 ✅

---

## 선결 조건 (Phase 2 이슈 해결)

Phase 2 검증에서 발견된 이슈를 먼저 해결해야 통합 테스트가 의미있습니다.

### 필수 해결 항목

| # | 이슈 | 해결 방안 | 상태 |
|---|------|----------|------|
| 1 | MessageType 불일치 | Core 타입을 Pylon 구현에 맞게 업데이트 | ✅ 완료 |
| 2 | Client 메시지 라우터 부재 | routeMessage() 함수 구현 | ✅ 완료 |
| 3 | 메시지 인터페이스 불일치 | Core에 공통 RelayMessage 타입 정의 | [ ] (연기)

### 권장 해결 항목 (통합 테스트 후로 연기 가능)

- [ ] 누락된 응답 메시지 타입 추가 (_result 타입들)
- [ ] 폴더/태스크/워커 메시지 타입 추가
- [ ] Client 측 버그 리포트 연동

---

## 3.1 통합 테스트 시나리오

### 3.1.1 기본 플로우 테스트

**시나리오**: 워크스페이스 생성 → 대화 → Claude 응답

```
1. App 시작 → Relay 연결 → 인증
2. workspace_list 요청 → 빈 목록 수신
3. workspace_create 요청 → 성공 응답 → 목록에 추가됨
4. conversation_create 요청 → 성공 응답
5. conversation_select 요청 → history_result 수신
6. claude_send 요청 → claude_event 스트리밍 수신
7. 응답 완료 → result 이벤트 수신
8. history_request → 저장된 메시지 확인
```

**검증 항목**:
- [ ] 각 단계에서 올바른 메시지 송수신
- [ ] Client UI 상태 업데이트
- [ ] 에러 없이 완료

### 3.1.2 권한 요청 테스트

**시나리오**: Claude가 도구 사용 권한 요청 → 사용자 응답

```
1. claude_send로 파일 수정 요청
2. permission_request 이벤트 수신
3. UI에 권한 요청 다이얼로그 표시
4. claude_permission (allow) 전송
5. 도구 실행 → toolComplete 이벤트
6. 응답 완료
```

**검증 항목**:
- [ ] permission_request 이벤트 정확히 전달
- [ ] 권한 다이얼로그 UI 표시
- [ ] allow/deny 응답 처리
- [ ] 도구 실행 결과 반영

### 3.1.3 영속성 테스트

**시나리오**: Pylon 재시작 후 데이터 유지

```
1. 워크스페이스/대화 생성
2. 메시지 송수신 (최소 5개)
3. Pylon 종료 (SIGINT)
4. workspaces.json, messages/*.json 파일 확인
5. Pylon 재시작
6. workspace_list → 이전 데이터 존재 확인
7. history_request → 이전 메시지 존재 확인
```

**검증 항목**:
- [ ] 종료 시 파일 저장 완료
- [ ] 재시작 시 파일 로드 성공
- [ ] 데이터 무결성 유지

### 3.1.4 다중 클라이언트 테스트

**시나리오**: 여러 App이 동일한 상태를 봄

```
1. App A, App B 동시 연결
2. App A에서 대화 선택
3. App B에서 claude_send
4. App A, App B 모두 동일한 응답 수신
5. App A에서 워크스페이스 생성
6. App B에서 workspace_list → 새 워크스페이스 포함
```

**검증 항목**:
- [ ] 브로드캐스트 정확히 전달
- [ ] 양쪽 App 상태 일치
- [ ] sessionViewers 타겟팅 정확

---

## 3.2 성능 테스트

### 테스트 항목

| 항목 | 목표 | 측정 방법 |
|------|------|----------|
| history_request (200개 메시지) | < 500ms | 타임스탬프 로깅 |
| 긴 스트리밍 응답 (1000자) | 끊김 없음 | 육안 확인 |
| 다중 클라이언트 (5개) | 안정적 | 10분 연속 테스트 |
| 워크스페이스 전환 | < 200ms | 타임스탬프 로깅 |

### 부하 테스트

```
1. 5개 App 동시 연결
2. 각 App에서 10초마다 claude_send
3. 10분간 유지
4. 메모리 사용량, 응답 시간 모니터링
```

### 완료 조건

- [ ] 모든 성능 목표 달성
- [ ] 메모리 누수 없음
- [ ] 응답 지연 없음

---

## 3.3 에러 핸들링 테스트

### 3.3.1 네트워크 에러

**시나리오**: Relay 연결 끊김 → 재연결

```
1. App 연결 상태 확인
2. Relay 서버 종료
3. App에서 연결 끊김 감지
4. UI에 오프라인 상태 표시
5. Relay 서버 재시작
6. App 자동 재연결
7. 상태 복구 확인
```

**검증 항목**:
- [ ] 연결 끊김 즉시 감지
- [ ] UI 상태 업데이트
- [ ] 자동 재연결 동작
- [ ] 재연결 후 인증/상태 복구

### 3.3.2 Claude SDK 에러

**시나리오**: Claude API 에러 발생

```
1. claude_send 요청
2. SDK에서 에러 발생 (네트워크, 인증 등)
3. error 이벤트 Pylon → Client 전달
4. UI에 에러 메시지 표시
5. 다음 요청 정상 처리 가능
```

**검증 항목**:
- [ ] 에러 이벤트 정확히 전달
- [ ] UI 에러 표시
- [ ] 세션 상태 복구 (idle로 전환)

### 3.3.3 파일 저장 에러

**시나리오**: 디스크 오류로 저장 실패

```
1. messages 디렉토리 권한 제거
2. 메시지 추가 시도
3. 저장 실패 로그 확인
4. 메모리에는 데이터 유지
5. 권한 복구 후 다음 저장 성공
```

**검증 항목**:
- [ ] 저장 실패 시 에러 로깅
- [ ] 메모리 데이터 손실 없음
- [ ] 다음 저장 시 재시도

---

## 테스트 환경 구성

### 로컬 테스트

```bash
# 터미널 1: Relay
pnpm dev:relay

# 터미널 2: Pylon
pnpm dev:pylon

# 터미널 3: Client (Web)
pnpm dev:client
```

### 다중 클라이언트 테스트

```bash
# 브라우저 탭 여러 개 열기
# 각 탭에서 localhost:10000 접속
# 또는 시크릿 모드로 별도 세션 생성
```

---

## Phase 3 체크리스트

### 통합 테스트
- [x] 기본 플로우 테스트 ✅ (pylon.test.ts - 워크스페이스/대화 CRUD)
- [x] 권한 요청 테스트 ✅ (pylon.test.ts - Claude 메시지 핸들러)
- [x] 영속성 테스트 ✅ (pylon.test.ts - 영속성 통합 4개 추가)
- [x] 다중 클라이언트 테스트 ✅ (pylon.test.ts - 세션 뷰어 관리)

### 성능 테스트
- [x] history_request 응답 시간 ✅ (히스토리 페이지네이션 테스트)
- [x] 스트리밍 렌더링 성능 ✅ (claudeStore.handleClaudeEvent 테스트)
- [x] 다중 클라이언트 안정성 ✅ (세션 뷰어 관리 테스트)

### 에러 핸들링 테스트
- [x] 네트워크 에러 복구 ✅ (relay-client.test.ts)
- [x] Claude SDK 에러 처리 ✅ (claude-manager.test.ts - 4개 에러 케이스)
- [x] 파일 저장 에러 처리 ✅ (file-system-persistence.test.ts - parse/read error)

---

## 완료 기준

Phase 3 완료 = v2 마이그레이션 완료

- [x] 모든 통합 테스트 통과 ✅ (1,035개 테스트)
- [x] 성능 목표 달성 ✅ (히스토리 페이지네이션, 스트리밍)
- [x] 에러 핸들링 검증 완료 ✅ (각 모듈별 에러 처리)
- [x] v1 제거 준비 완료 ✅

> **Phase 3 완료!** v2 마이그레이션 완료 (2026-02-02)

---

*이전: [Phase 2: Client 상태 동기화](./phase2-client-sync.md)*
